<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ego Premium Dashboard</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono&display=swap");

      :root {
        --bg-dark: #050510;
        --bg-panel: rgba(16, 16, 35, 0.7);
        --primary: #c160ef;
        --primary-glow: rgba(193, 96, 239, 0.4);
        --secondary: #7000ff;
        --accent: #00f2ff;
        --success: #00ff9d;
        --danger: #ff0055;
        --warning: #ffcc00;
        --text-main: #ffffff;
        --text-dim: #a0a0c0;
        --glass-border: rgba(255, 255, 255, 0.1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        scrollbar-width: thin;
        scrollbar-color: var(--primary) transparent;
      }

      body {
        font-family: "Outfit", sans-serif;
        background: radial-gradient(circle at top right, #1a0b2e, #050510);
        background-attachment: fixed;
        color: var(--text-main);
        padding: 30px;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Premium Glassmorphism */
      .glass {
        background: var(--bg-panel);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        animation: fadeIn 0.8s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Header & Master Toggle */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
      }

      .logo-area h1 {
        font-size: 32px;
        font-weight: 700;
        background: linear-gradient(to right, var(--primary), var(--accent));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
      }

      .master-toggle-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .power-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        background: var(--bg-panel);
        border: 2px solid var(--glass-border);
        box-shadow: 0 0 0 rgba(193, 96, 239, 0);
      }

      .power-btn i {
        font-style: normal;
        font-size: 24px;
      }

      .power-btn.active {
        background: var(--primary);
        border-color: var(--primary-light);
        box-shadow: 0 0 20px var(--primary-glow);
        transform: scale(1.1);
      }

      /* Navigation */
      nav {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        padding: 10px;
      }

      .nav-item {
        padding: 12px 24px;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.3s;
        font-weight: 600;
        color: var(--text-dim);
        border: 1px solid transparent;
      }

      .nav-item:hover {
        color: var(--text-main);
        background: rgba(255, 255, 255, 0.05);
      }

      .nav-item.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px var(--primary-glow);
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .stat-card {
        padding: 25px;
        text-align: left;
        position: relative;
        overflow: hidden;
        z-index: 1;
      }

      .stat-card::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.03) 0%,
          transparent 70%
        );
        pointer-events: none;
        z-index: -1;
      }

      .stat-label {
        font-size: 13px;
        text-transform: uppercase;
        color: var(--text-dim);
        letter-spacing: 1px;
        display: block;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 42px;
        font-weight: 700;
        font-family: "JetBrains Mono", monospace;
        position: relative;
        z-index: 2;
      }

      .stat-card.primary .stat-value {
        color: var(--primary);
      }
      .stat-card.success .stat-value {
        color: var(--success);
      }
      .stat-card.danger .stat-value {
        color: var(--danger);
      }
      .stat-card.warning .stat-value {
        color: var(--warning);
      }

      /* Settings Panels */
      .panel-content {
        display: none;
        animation: slideUp 0.5s ease-out;
      }

      .panel-content.active {
        display: block;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card {
        padding: 25px;
        margin-bottom: 20px;
      }

      h2 {
        font-size: 18px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--primary);
      }

      .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--glass-border);
      }

      .setting-item:last-child {
        border: none;
      }

      .setting-info h4 {
        font-size: 15px;
        margin-bottom: 4px;
      }
      .setting-info p {
        font-size: 12px;
        color: var(--text-dim);
      }

      /* Switches & Inputs */
      .switch {
        position: relative;
        display: inline-block;
        width: 54px;
        height: 28px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #222;
        transition: 0.4s;
        border-radius: 34px;
        border: 1px solid var(--glass-border);
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--primary);
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }

      select,
      input[type="number"],
      textarea {
        background: #101025;
        border: 1px solid var(--glass-border);
        color: white;
        padding: 8px 15px;
        border-radius: 8px;
        font-family: inherit;
        outline: none;
      }

      textarea {
        width: 100%;
        min-height: 120px;
        margin-top: 10px;
        font-family: "JetBrains Mono";
        font-size: 12px;
      }

      .btn {
        background: linear-gradient(to right, var(--primary), var(--secondary));
        border: none;
        color: white;
        padding: 12px 25px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px var(--primary-glow);
      }

      /* Activity Log */
      .log-list {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
      }

      .log-item {
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
        border-left: 3px solid var(--primary);
      }

      .log-item.blocked {
        border-left-color: var(--danger);
      }
      .log-item.skipped {
        border-left-color: var(--warning);
      }

      .log-tag {
        font-size: 10px;
        font-weight: 700;
        padding: 3px 8px;
        border-radius: 4px;
        text-transform: uppercase;
      }

      .log-content {
        flex: 1;
        font-size: 13px;
      }
      .log-time {
        font-size: 11px;
        color: var(--text-dim);
      }

      /* Quota List */
      .quota-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .quota-item {
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        border-left: 3px solid var(--primary);
      }

      .quota-item.low {
        border-left-color: var(--warning);
      }

      .quota-item.critical {
        border-left-color: var(--danger);
      }

      .quota-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .quota-model-name {
        font-weight: 600;
        font-size: 14px;
      }

      .quota-percentage {
        font-weight: 700;
        font-size: 14px;
        color: var(--primary);
      }

      .quota-percentage.low {
        color: var(--warning);
      }

      .quota-percentage.critical {
        color: var(--danger);
      }

      .quota-progress {
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 6px;
      }

      .quota-progress-bar {
        height: 100%;
        background: linear-gradient(to right, var(--secondary), var(--primary));
        border-radius: 3px;
      }

      .quota-progress-bar.low {
        background: var(--warning);
      }

      .quota-progress-bar.critical {
        background: var(--danger);
      }

      .quota-reset {
        font-size: 11px;
        color: var(--text-dim);
      }

      .quota-loading,
      .quota-error {
        text-align: center;
        padding: 30px;
        color: var(--text-dim);
      }

      .quota-error {
        color: var(--danger);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="glass">
        <div class="logo-area">
          <h1 id="txt-app-name">EGO</h1>
        </div>
        <div class="master-toggle-container">
          <button class="power-btn" id="master-toggle">
            <i>⏻</i>
          </button>
        </div>
      </header>

      <nav class="glass">
        <div class="nav-item active" data-panel="stats" id="nav-stats">
          Statistics
        </div>
        <div class="nav-item" data-panel="categories" id="nav-categories">
          Categories
        </div>
        <div class="nav-item" data-panel="security" id="nav-security">
          Security
        </div>
        <div class="nav-item" data-panel="logs" id="nav-logs">Logs</div>
        <div class="nav-item" data-panel="quota" id="nav-quota">Quota</div>
      </nav>

      <!-- statistics Panel -->
      <div id="panel-stats" class="panel-content active">
        <div class="stats-grid">
          <div class="stat-card glass success">
            <span class="stat-label" id="lbl-accepted">Accepted</span>
            <span class="stat-value" id="val-accepted">0</span>
          </div>
          <div class="stat-card glass danger">
            <span class="stat-label" id="lbl-blocked">Blocked</span>
            <span class="stat-value" id="val-blocked">0</span>
          </div>
          <div class="stat-card glass warning">
            <span class="stat-label" id="lbl-skipped">Skipped</span>
            <span class="stat-value" id="val-skipped">0</span>
          </div>
          <div class="stat-card glass primary">
            <span class="stat-label" id="lbl-agents">Active Agents</span>
            <span class="stat-value" id="val-agents">0</span>
          </div>
        </div>

        <!-- Reset Button -->
        <div
          style="display: flex; justify-content: flex-end; margin-bottom: 20px"
        >
          <button
            class="btn"
            style="
              padding: 6px 15px;
              font-size: 12px;
              background: rgba(255, 50, 50, 0.2);
              border: 1px solid rgba(255, 50, 50, 0.3);
              color: #ff9999;
            "
            id="btn-reset-stats"
          >
            <span id="btn-reset-text">Reset Statistics</span>
          </button>
        </div>

        <div class="card glass">
          <h2 id="hdr-general">General Settings</h2>
          <div class="setting-item">
            <div class="setting-info">
              <h4 id="lbl-lang">Language</h4>
              <p id="hint-lang">Preferred UI language</p>
            </div>
            <select id="set-language">
              <option value="tr">Türkçe</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Categories Panel -->
      <div id="panel-categories" class="panel-content">
        <div class="card glass">
          <h2 id="hdr-categories">Selective Approval</h2>
          <p
            style="font-size: 13px; color: var(--text-dim); margin-bottom: 20px"
            id="hint-categories"
          >
            Choose which agent actions to automate
          </p>

          <div class="setting-item">
            <div class="setting-info">
              <h4 id="cat-files">File Edits</h4>
              <p id="cat-files-hint">Automate code modifications</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="check-files" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4 id="cat-terminal">Terminal Commands</h4>
              <p id="cat-terminal-hint">Automate shell execution</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="check-terminal" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4 id="cat-dialogs">Confirmation Dialogs</h4>
              <p id="cat-dialogs-hint">Automate VS Code popups</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="check-dialogs" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4 id="cat-git">Git Operations</h4>
              <p id="cat-git-hint">Automate git commands</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="check-git" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4 id="cat-package">Package Management</h4>
              <p id="cat-package-hint">Automate npm/pip/yarn</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="check-package" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Security Panel -->
      <div id="panel-security" class="panel-content">
        <div class="card glass">
          <h2 id="hdr-security">Advanced Security</h2>
          <div class="setting-item">
            <div class="setting-info">
              <h4 id="lbl-safe-mode">Safe Mode</h4>
              <p id="hint-safe-mode">Only allow commands in manual whitelist</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="check-safe-mode" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4 id="lbl-threat-action">Action on Threat</h4>
              <p id="hint-threat-action">What to do when danger detected</p>
            </div>
            <select id="set-threat-action">
              <option value="stop">Stop Agent</option>
              <option value="skip">Skip Step</option>
            </select>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4 id="lbl-threshold">Danger Threshold</h4>
              <p id="hint-threshold">Score limit to block commands (0-100)</p>
            </div>
            <div style="display: flex; align-items: center; gap: 10px">
              <input
                type="range"
                id="set-threshold"
                min="0"
                max="100"
                step="5"
              />
              <span id="threshold-display" style="min-width: 35px">70</span>
            </div>
          </div>
        </div>

        <div class="card glass">
          <h2 id="lbl-whitelist">Whitelist</h2>
          <textarea
            id="area-whitelist"
            placeholder="Enter trusted paths or commands..."
          ></textarea>
          <button class="btn" id="btn-save-whitelist">Save Whitelist</button>
        </div>

        <div class="card glass">
          <h2 id="lbl-blacklist">Blacklist</h2>
          <textarea
            id="area-blacklist"
            placeholder="Enter dangerous commands to block..."
          ></textarea>
          <button class="btn" id="btn-save-blacklist">Save Blacklist</button>
        </div>
      </div>

      <!-- Logs Panel -->
      <div id="panel-logs" class="panel-content">
        <div class="card glass">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
              flex-wrap: wrap;
              gap: 15px;
            "
          >
            <h2 style="margin: 0" id="hdr-logs">Activity Log</h2>
            <div style="display: flex; gap: 10px; align-items: center">
              <select id="filter-action" style="padding: 6px 12px">
                <option value="all">All Types</option>
                <option value="accepted">Accepted</option>
                <option value="blocked">Blocked</option>
                <option value="skipped">Skipped</option>
              </select>
              <select id="filter-category" style="padding: 6px 12px">
                <option value="all">All Categories</option>
                <option value="files">Files</option>
                <option value="terminal">Terminal</option>
                <option value="git">Git</option>
                <option value="package">Package</option>
                <option value="dialogs">Dialogs</option>
              </select>
              <button class="btn" style="padding: 8px 15px" id="btn-clear-logs">
                Clear
              </button>
            </div>
          </div>
          <div class="log-list" id="log-list">
            <!-- Logs injected here -->
          </div>
        </div>
      </div>

      <!-- Quota Panel -->
      <div id="panel-quota" class="panel-content">
        <div class="card glass">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="margin: 0" id="hdr-quota">AI Model Quotas</h2>
            <button
              class="btn"
              style="padding: 8px 15px"
              id="btn-refresh-quota"
            >
              <span id="btn-refresh-quota-text">Refresh</span>
            </button>
          </div>
          <div id="quota-list" class="quota-list">
            <div class="quota-loading" id="quota-loading">
              <span id="quota-loading-text">Loading...</span>
            </div>
          </div>
          <div id="quota-error" class="quota-error" style="display: none">
            <span id="quota-error-text"></span>
          </div>
        </div>
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      let currentTranslations = {};
      let allLogs = [];

      // Tab Switching Logic
      document.querySelectorAll(".nav-item").forEach((dot) => {
        dot.addEventListener("click", () => {
          const target = dot.dataset.panel;
          document
            .querySelectorAll(".nav-item")
            .forEach((i) => i.classList.remove("active"));
          document
            .querySelectorAll(".panel-content")
            .forEach((p) => p.classList.remove("active"));
          dot.classList.add("active");
          document.getElementById("panel-" + target).classList.add("active");
        });
      });

      // Toggle Master Logic
      const masterBtn = document.getElementById("master-toggle");
      masterBtn.addEventListener("click", () => {
        const isActive = masterBtn.classList.contains("active");
        vscode.postMessage({
          type: "setting",
          key: "enabled",
          value: !isActive,
        });
      });

      // Config Change Handlers
      document
        .getElementById("set-language")
        .addEventListener("change", (e) => {
          vscode.postMessage({
            type: "setting",
            key: "language",
            value: e.target.value,
          });
        });

      document.querySelectorAll('input[type="checkbox"]').forEach((check) => {
        check.addEventListener("change", () => {
          let key = check.id.replace("check-", "");
          if (
            ["files", "terminal", "dialogs", "git", "package"].includes(key)
          ) {
            key = "categories." + key;
          } else if (key === "safe-mode") {
            key = "safeMode";
          }
          vscode.postMessage({
            type: "setting",
            key: key,
            value: check.checked,
          });
        });
      });

      document
        .getElementById("set-threat-action")
        .addEventListener("change", (e) => {
          vscode.postMessage({
            type: "setting",
            key: "onThreatAction",
            value: e.target.value,
          });
        });

      document
        .getElementById("btn-save-whitelist")
        .addEventListener("click", () => {
          const list = document
            .getElementById("area-whitelist")
            .value.split("\n")
            .filter((x) => x.trim());
          vscode.postMessage({
            type: "setting",
            key: "whitelist",
            value: list,
          });
        });

      document
        .getElementById("set-threshold")
        .addEventListener("input", (e) => {
          document.getElementById("threshold-display").textContent =
            e.target.value;
          vscode.postMessage({
            type: "setting",
            key: "dangerThreshold",
            value: parseInt(e.target.value),
          });
        });

      document
        .getElementById("btn-save-blacklist")
        .addEventListener("click", () => {
          const list = document
            .getElementById("area-blacklist")
            .value.split("\n")
            .filter((x) => x.trim());
          vscode.postMessage({
            type: "setting",
            key: "customBlacklist",
            value: list,
          });
        });

      document
        .getElementById("btn-clear-logs")
        .addEventListener("click", () => {
          vscode.postMessage({ type: "clearLogs" });
        });

      // Message Handling
      window.addEventListener("message", (event) => {
        const msg = event.data;
        if (msg.type === "update") {
          updateUI(msg);
        }
      });

      function updateUI(data) {
        // Stats
        document.getElementById("val-accepted").textContent =
          data.stats.totalAccepted;
        document.getElementById("val-blocked").textContent =
          data.stats.totalBlocked;
        document.getElementById("val-skipped").textContent =
          data.stats.totalSkipped;
        document.getElementById("val-agents").textContent =
          data.agentCount || 0;

        // Master Toggle
        if (data.config.enabled) {
          masterBtn.classList.add("active");
        } else {
          masterBtn.classList.remove("active");
        }

        // sync inputs to config (prevents reset)
        document.getElementById("set-language").value = data.config.language;
        document.getElementById("set-threat-action").value =
          data.config.onThreatAction;
        document.getElementById("check-safe-mode").checked =
          data.config.safeMode;

        document.getElementById("check-files").checked =
          data.config.categories.files;
        document.getElementById("check-terminal").checked =
          data.config.categories.terminal;
        document.getElementById("check-dialogs").checked =
          data.config.categories.dialogs;
        document.getElementById("check-git").checked =
          data.config.categories.git;
        document.getElementById("check-package").checked =
          data.config.categories.package;

        document.getElementById("area-whitelist").value =
          data.config.whitelist.join("\n");
        document.getElementById("set-threshold").value =
          data.config.dangerThreshold;
        document.getElementById("threshold-display").textContent =
          data.config.dangerThreshold;
        document.getElementById("area-blacklist").value =
          data.config.customBlacklist.join("\n");

        // Apply Translations
        if (data.translations) {
          applyTranslations(data.translations);
        }

        // Render Logs
        if (data.logs) {
          allLogs = data.logs;
          renderFilteredLogs();
        }
      }

      function renderFilteredLogs() {
        const actionFilter = document.getElementById("filter-action").value;
        const categoryFilter = document.getElementById("filter-category").value;

        const filteredLogs = allLogs.filter((log) => {
          const actionMatch =
            actionFilter === "all" || log.action === actionFilter;
          const categoryMatch =
            categoryFilter === "all" || log.category === categoryFilter;
          return actionMatch && categoryMatch;
        });

        const logList = document.getElementById("log-list");
        logList.innerHTML = filteredLogs
          .map(
            (log) => `
              <div class="log-item ${log.action}">
                <span class="log-time" style="min-width: 45px">${
                  log.timestamp || ""
                }</span>
                <span class="log-tag ${log.action}">${log.action}</span>
                <div class="log-content">${log.detail}</div>
                <span class="log-time">${log.category}</span>
              </div>
            `,
          )
          .join("");
      }

      // Filter event handlers
      document
        .getElementById("filter-action")
        .addEventListener("change", renderFilteredLogs);
      document
        .getElementById("filter-category")
        .addEventListener("change", renderFilteredLogs);

      function applyTranslations(t) {
        document.getElementById("nav-stats").textContent =
          t["dashboard.tabs.stats"];
        document.getElementById("nav-categories").textContent =
          t["dashboard.tabs.categories"];
        document.getElementById("nav-security").textContent =
          t["dashboard.tabs.security"];
        document.getElementById("nav-logs").textContent =
          t["dashboard.tabs.logs"];

        document.getElementById("lbl-accepted").textContent =
          t["dashboard.stats.accepted"];
        document.getElementById("lbl-blocked").textContent =
          t["dashboard.stats.blocked"];
        document.getElementById("lbl-skipped").textContent =
          t["dashboard.stats.skipped"];
        document.getElementById("lbl-agents").textContent =
          t["dashboard.stats.agents"];

        document.getElementById("hdr-general").textContent =
          t["dashboard.settings.general"];
        document.getElementById("lbl-lang").textContent =
          t["dashboard.settings.language"];
        document.getElementById("lbl-threat-action").textContent =
          t["dashboard.settings.threatAction"];
        document.getElementById("lbl-safe-mode").textContent =
          t["dashboard.settings.safeMode"];
        document.getElementById("hdr-categories").textContent =
          t["dashboard.tabs.categories"];
        document.getElementById("hdr-security").textContent =
          t["dashboard.tabs.security"];
        document.getElementById("hdr-logs").textContent =
          t["dashboard.tabs.logs"];

        document.getElementById("cat-files").textContent =
          t["dashboard.categories.files"];
        document.getElementById("cat-terminal").textContent =
          t["dashboard.categories.terminal"];
        document.getElementById("cat-dialogs").textContent =
          t["dashboard.categories.dialogs"];
        document.getElementById("cat-git").textContent =
          t["dashboard.categories.git"];
        document.getElementById("cat-package").textContent =
          t["dashboard.categories.package"];

        document.getElementById("btn-save-whitelist").textContent =
          t["dashboard.settings.save"];
        document.getElementById("btn-save-blacklist").textContent =
          t["dashboard.settings.save"];
        document.getElementById("btn-clear-logs").textContent =
          t["dashboard.settings.clearLogs"];
        document.getElementById("lbl-threshold").textContent =
          t["dashboard.settings.threshold"];
        document.getElementById("lbl-whitelist").textContent =
          t["dashboard.settings.whitelist"];
        document.getElementById("lbl-blacklist").textContent =
          t["dashboard.settings.blacklist"];

        // Quota translations
        const quotaTab = document.getElementById("nav-quota");
        if (quotaTab) quotaTab.textContent = t["dashboard.tabs.quota"];

        const quotaTitle = document.getElementById("hdr-quota");
        if (quotaTitle) quotaTitle.textContent = t["quota.title"];

        const refreshBtnText = document.getElementById(
          "btn-refresh-quota-text",
        );
        if (refreshBtnText) refreshBtnText.textContent = t["quota.refresh"];

        const quotaLoadingText = document.getElementById("quota-loading-text");
        if (quotaLoadingText) quotaLoadingText.textContent = t["quota.loading"];

        document.getElementById("btn-reset-text").textContent =
          t["dashboard.stats.reset"];

        currentTranslations = t;
      }

      function escapeHtml(text) {
        if (!text) return "";
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Quota rendering
      function renderQuotaList(models, translations) {
        const quotaList = document.getElementById("quota-list");
        const quotaLoading = document.getElementById("quota-loading");
        const quotaError = document.getElementById("quota-error");

        quotaLoading.style.display = "none";
        quotaError.style.display = "none";

        if (!models || models.length === 0) {
          quotaList.innerHTML =
            '<div class="quota-loading">No quota data available</div>';
          return;
        }

        const t = translations || currentTranslations || {};
        const resetsInText = t["quota.resetsIn"] || "Resets in";

        quotaList.innerHTML = models
          .map((model) => {
            const pct = model.remainingPercentage || 0;
            const status = pct <= 10 ? "critical" : pct <= 30 ? "low" : "";

            return `
            <div class="quota-item ${status}">
              <div class="quota-header">
                <span class="quota-model-name">${escapeHtml(model.label)}</span>
                <span class="quota-percentage ${status}">${pct.toFixed(
                  0,
                )}%</span>
              </div>
              <div class="quota-progress">
                <div class="quota-progress-bar ${status}" style="width: ${pct}%"></div>
              </div>
              <div class="quota-reset">${resetsInText}: ${
                model.timeUntilResetFormatted
              }</div>
            </div>
          `;
          })
          .join("");
      }

      function showQuotaError(errorType, translations) {
        const quotaLoading = document.getElementById("quota-loading");
        const quotaError = document.getElementById("quota-error");
        const quotaErrorText = document.getElementById("quota-error-text");
        const t = translations || currentTranslations;

        quotaLoading.style.display = "none";
        quotaError.style.display = "block";

        if (errorType === "process_not_found") {
          quotaErrorText.textContent =
            t["quota.error.processNotFound"] || "Antigravity process not found";
        } else {
          quotaErrorText.textContent =
            t["quota.error.fetchFailed"] || "Failed to fetch quota";
        }
      }

      // Refresh button handler
      document
        .getElementById("btn-refresh-quota")
        .addEventListener("click", () => {
          const btn = document.getElementById("btn-refresh-quota");
          const btnText = document.getElementById("btn-refresh-quota-text");

          // Disable button and show loading state
          btn.disabled = true;
          btn.style.opacity = "0.6";
          btn.style.cursor = "not-allowed";
          btnText.textContent =
            currentTranslations["quota.refreshing"] || "Refreshing...";

          document.getElementById("quota-loading").style.display = "block";
          document.getElementById("quota-error").style.display = "none";
          vscode.postMessage({ type: "refreshQuota" });
        });

      // Listen for quota updates
      window.addEventListener("message", (event) => {
        const data = event.data;
        if (data.type === "quotaUpdate") {
          if (data.error) {
            showQuotaError(data.error, data.translations);
          } else {
            renderQuotaList(data.models, data.translations);
          }

          // Re-enable refresh button
          const btn = document.getElementById("btn-refresh-quota");
          const btnText = document.getElementById("btn-refresh-quota-text");
          btn.disabled = false;
          btn.style.opacity = "1";
          btn.style.cursor = "pointer";
          btnText.textContent =
            (data.translations || currentTranslations)["quota.refresh"] ||
            "Refresh";
        }
      });

      // Reset Stats Handler
      const btnResetStats = document.getElementById("btn-reset-stats");
      if (btnResetStats) {
        btnResetStats.addEventListener("click", () => {
          vscode.postMessage({ type: "resetStats" });
        });
      }
    </script>
  </body>
</html>
